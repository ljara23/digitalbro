name: Deploy to Server

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout del código
    - name: Checkout code
      uses: actions/checkout@v2

    # 2. Configuración de la clave SSH
    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    # 3. Configuración de la passphrase (si la clave tiene passphrase)
    - name: Set up SSH passphrase
      run: |
        mkdir -p ~/.ssh
        echo "$SERVER_SSH_KEY" > ~/.ssh/id_rsa
        echo "$SERVER_PASSPHRASE" | ssh-add ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      env:
        SSH_PASSPHRASE: ${{ secrets.SERVER_PASSPHRASE }}

    # 4. Conectarse al servidor mediante SSH
    - name: SSH into the server and deploy
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        port: 22
        key: ${{ secrets.SERVER_SSH_KEY }}
        passphrase: ${{ secrets.SERVER_PASSPHRASE }}
        script: |
          # El script que deseas ejecutar en el servidor.
          cd /ruta/del/directorio
          # Realiza las operaciones necesarias (por ejemplo, eliminar archivos antiguos, etc.)
          rm -rf *  # Esto elimina todos los archivos anteriores
          # Otros comandos que necesitas ejecutar en el servidor
